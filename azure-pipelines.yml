trigger: none
pr: none

variables:
  serviceConnection: 'ado-bcsit'   # set this to your service connection name
  rgName: 'rg-ae-revbc'

stages:
- stage: Build
  displayName: Validate Bicep
  jobs:
  - job: lint
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self
    - task: AzureCLI@2
      displayName: Bicep Lint
      inputs:
        azureSubscription: $(serviceConnection)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          ROOT="$(Build.SourcesDirectory)"
          if [ ! -f "$ROOT/main.bicep" ]; then ROOT="$ROOT/$(Build.Repository.Name)"; fi
          if [ ! -f "$ROOT/main.bicep" ]; then
            echo "main.bicep not found under $(Build.SourcesDirectory)"
            find "$(Build.SourcesDirectory)" -maxdepth 4 -name main.bicep
            exit 1
          fi
          az bicep build --file "$ROOT/main.bicep"

- stage: SIT
  dependsOn: Build
  jobs:
  - deployment: deploy_sit
    environment: SIT
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          - task: AzureCLI@2
            displayName: Deploy SIT
            inputs:
              azureSubscription: $(serviceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                ROOT="$(Build.SourcesDirectory)"
                if [ ! -f "$ROOT/main.bicep" ]; then ROOT="$ROOT/$(Build.Repository.Name)"; fi
                if [ ! -f "$ROOT/main.bicep" ]; then
                  echo "main.bicep not found under $(Build.SourcesDirectory)"
                  find "$(Build.SourcesDirectory)" -maxdepth 4 -name main.bicep
                  exit 1
                fi
                az deployment group create \
                  --resource-group $(rgName) \
                  --template-file "$ROOT/main.bicep" \
                  --parameters @"$ROOT/parameters.json" \
                  --parameters tags='{"owner":"infra","app":"revbc","env":"sit"}'

          - task: AzureCLI@2
            displayName: Push Image to ACR (SIT)
            inputs:
              azureSubscription: $(serviceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                ROOT="$(Build.SourcesDirectory)"
                if [ ! -f "$ROOT/main.bicep" ]; then ROOT="$ROOT/$(Build.Repository.Name)"; fi
                cd "$ROOT"
                az acr login --name acraetestrevbc
                docker build -t acraetestrevbc.azurecr.io/app:$(Build.BuildId) .
                docker push acraetestrevbc.azurecr.io/app:$(Build.BuildId)

- stage: UAT
  dependsOn: SIT
  condition: succeeded()
  jobs:
  - deployment: deploy_uat
    environment: UAT
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          - task: AzureCLI@2
            displayName: Deploy UAT
            inputs:
              azureSubscription: $(serviceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                ROOT="$(Build.SourcesDirectory)"
                if [ ! -f "$ROOT/main.bicep" ]; then ROOT="$ROOT/$(Build.Repository.Name)"; fi
                if [ ! -f "$ROOT/main.bicep" ]; then
                  echo "main.bicep not found under $(Build.SourcesDirectory)"
                  find "$(Build.SourcesDirectory)" -maxdepth 4 -name main.bicep
                  exit 1
                fi
                az deployment group create \
                  --resource-group $(rgName) \
                  --template-file "$ROOT/main.bicep" \
                  --parameters @"$ROOT/parameters.json" \
                  --parameters tags='{"owner":"infra","app":"revbc","env":"uat"}'

- stage: PROD
  dependsOn: UAT
  condition: succeeded()
  jobs:
  - deployment: deploy_prod
    environment: PROD
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          - task: AzureCLI@2
            displayName: Deploy PROD
            inputs:
              azureSubscription: $(serviceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                ROOT="$(Build.SourcesDirectory)"
                if [ ! -f "$ROOT/main.bicep" ]; then ROOT="$ROOT/$(Build.Repository.Name)"; fi
                if [ ! -f "$ROOT/main.bicep" ]; then
                  echo "main.bicep not found under $(Build.SourcesDirectory)"
                  find "$(Build.SourcesDirectory)" -maxdepth 4 -name main.bicep
                  exit 1
                fi
                az deployment group create \
                  --resource-group $(rgName) \
                  --template-file "$ROOT/main.bicep" \
                  --parameters @"$ROOT/parameters.json" \
                  --parameters tags='{"owner":"infra","app":"revbc","env":"prod"}'